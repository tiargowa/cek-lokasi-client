<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cek Lokasi Client dan Simpan Data (Aman & Akurat)</title>
    <!-- Memuat Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Mengatur font utama menjadi Inter */
        body { font-family: 'Inter', sans-serif; }
        .spinner {
            border-top-color: #f97316; /* Orange-500 */
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @-webkit-keyframes spin {
            to { -webkit-transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center min-h-screen p-4">

    <!-- Kontainer Utama Card -->
    <div class="bg-white shadow-2xl rounded-3xl p-6 md:p-10 max-w-xl w-full transform transition duration-500 hover:scale-[1.01] hover:shadow-3xl border border-gray-100">
        
        <header class="text-center mb-8">
            <div class="flex justify-center items-center mb-2">
                <!-- Ikon GPS SVG -->
                <svg class="w-10 h-10 text-indigo-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <h1 class="text-3xl font-extrabold text-gray-800">Geolocation Tester</h1>
            </div>
            <p class="text-gray-500 text-sm">Cek, simpan, dan ukur akurasi lokasi perangkat Anda.</p>
        </header>
        
        <!-- Area Hasil -->
        <div id="result" class="text-gray-600 text-center min-h-[150px] flex items-center justify-center">
            Menunggu inisialisasi...
        </div>
        
        <p class="text-xs text-gray-400 mt-6 text-center border-t pt-4">Menggunakan **Firebase SDK V9 Modular** dan Otentikasi Anonim.</p>
    </div>

    <script type="module">
        // Import Firebase V9 Modular SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ====================================================================
        // Konfigurasi Kunci API dan Variabel Global
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // HARAP GANTI DENGAN KUNCI GOOGLE MAPS ANDA YANG SUDAH DIAKTIFKAN GEOCODING API-nya!
        const GOOGLE_MAPS_API_KEY = "AIzaSyAuObjcNZrJjdfrRN1c-sSwr0qGktoRgDE"; 
        // ====================================================================

        const resultDiv = document.getElementById('result');
        let db, auth, userId;
        // PASTIKAN ANDA MENGGANTI INI DENGAN KONFIGURASI PROYEK FIREBASE ANDA
        const firebaseConfig = {
            apiKey: "AIzaSyDMSnNTL2VnajEWkNY59WEgJVkZB_W7Vng",
            authDomain: "lokasi-client-tyar.firebaseapp.com",
            projectId: "lokasi-client-tyar",
            storageBucket: "lokasi-client-tyar.appspot.com",
            messagingSenderId: "53755341759",
            appId: "1:53755341759:web:c67c006b9b304c442e97f1"
        };

        // Inisialisasi Firebase dan Otentikasi (Mandatory)
        if (Object.keys(firebaseConfig).length > 0) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');

                async function authenticateAndStart() {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    userId = auth.currentUser.uid;
                    console.log(`Authenticated with userId: ${userId}`);
                    getLocation();
                }
                authenticateAndStart();
            } catch (error) {
                console.error("Firebase Initialization or Authentication Error:", error);
                resultDiv.innerHTML = `<div class='text-red-600 font-semibold p-4 bg-red-100 rounded-xl shadow'>‚ùå Gagal Inisialisasi/Otentikasi Firebase. Cek konsol.</div>`;
            }
        } else {
            console.error("Konfigurasi Firebase tidak tersedia.");
            resultDiv.innerHTML = `<div class='text-red-600 font-semibold p-4 bg-red-100 rounded-xl shadow'>‚ùå Gagal Inisialisasi Firebase. Cek konfigurasi.</div>`;
        }

        // Fungsi untuk mendapatkan Alamat Jalan/Kota dari Lat/Lon (Reverse Geocoding)
        async function getAddressFromLatLng(lat, lng) {
            if (GOOGLE_MAPS_API_KEY === "AIzaSyAuObjcNZrJjdfrRN1c-sSwr0qGktoRgDE") { 
                console.warn("GOOGLE_MAPS_API_KEY masih menggunakan placeholder. Reverse Geocoding mungkin gagal.");
            }

            const url = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${GOOGLE_MAPS_API_KEY}`;
            
            try {
                const response = await fetch(url);

                if (!response.ok) {
                    let errorMessage = `API Error: ${response.status} (Network issue)`;
                    return { fullAddress: errorMessage, cityOrDistrict: 'Error' };
                }

                const data = await response.json();

                if (data.status === 'OK' && data.results.length > 0) {
                    const fullAddress = data.results[0].formatted_address;
                    let cityOrDistrict = fullAddress;
                    const components = data.results[0].address_components;
                    
                    for (const component of components) {
                        if (component.types.includes("locality")) {
                            cityOrDistrict = component.long_name;
                            break;
                        }
                        if (component.types.includes("administrative_area_level_2")) {
                            cityOrDistrict = component.long_name;
                        }
                    }

                    return { fullAddress, cityOrDistrict };
                } else {
                    return { fullAddress: `Geocoding Status: ${data.status} (Pesan: ${data.error_message || 'Tidak ada pesan'})`, cityOrDistrict: 'Tidak Diketahui' };
                }
            } catch (error) {
                console.error("Gagal melakukan Reverse Geocoding (Koneksi Gagal):", error);
                return { fullAddress: 'Error: Gagal Fetch Geocoding', cityOrDistrict: 'Error' };
            }
        }

        // Fungsi utilitas untuk mendapatkan Nama Browser
        function getBrowserName(userAgent) {
            let browser = 'Unknown Browser';
            if (userAgent.indexOf("Chrome") > -1 && userAgent.indexOf("Edge") === -1 && userAgent.indexOf("OPR") === -1) {
                browser = 'Chrome';
            } else if (userAgent.indexOf("Firefox") > -1) {
                browser = 'Firefox';
            } else if (userAgent.indexOf("Safari") > -1 && userAgent.indexOf("Chrome") === -1) {
                browser = 'Safari';
            } else if (userAgent.indexOf("Edge") > -1) {
                browser = 'Edge';
            } else if (userAgent.indexOf("OPR") > -1) {
                browser = 'Opera';
            }
            return browser;
        }

        // Fungsi utilitas untuk mengurai UserAgent dan mendapatkan nama OS yang lebih baik dan Tipe Perangkat
        function getOSNameAndDeviceType(userAgent) {
            let os = 'Unknown OS';
            let deviceType = 'Desktop';
            
            // Cek OS
            if (userAgent.match(/Windows NT/i)) os = 'Windows';
            else if (userAgent.match(/Android/i)) os = 'Android';
            else if (userAgent.match(/iPhone|iPod/i)) os = 'iOS';
            else if (userAgent.match(/iPad/i)) os = 'iPadOS';
            else if (userAgent.match(/Macintosh|Mac OS X/i)) os = 'Mac OS';
            else if (userAgent.match(/Linux/i)) os = 'Linux';

            // Cek Tipe Perangkat
            if (userAgent.match(/Mobi/i)) {
                deviceType = 'Mobile Phone';
            } else if (userAgent.match(/Tablet|iPad/i)) {
                deviceType = 'Tablet';
            } else if (userAgent.match(/A(ndroid)?|WebOS|Tablet|mobile|iP(hone|od)|IEMobile|BlackBerry|Nokia|Kindle|Pad|Silk|Windows Phone/i)) {
                 deviceType = 'Mobile/Tablet';
            }
            
            return { os, deviceType };
        }

        // Fungsi baru untuk mendapatkan Alamat IP dari API eksternal
        async function getClientIpAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip || 'Tidak Ditemukan';
            } catch (error) {
                console.error("Gagal mendapatkan Alamat IP:", error);
                return 'Error: Cek Koneksi/API';
            }
        }

        // Fungsi utama untuk meminta Geolocation
        function getLocation() {
            if (navigator.geolocation) {
                // Tampilan Loading Awal (Menggunakan Tailwind dan Spinner SVG)
                resultDiv.innerHTML = `<div class="p-4 bg-orange-50 text-orange-700 rounded-xl flex flex-col items-center justify-center h-full">
                    <div class="spinner ease-linear rounded-full border-4 border-t-4 border-orange-200 h-10 w-10 mb-3"></div>
                    <span class="font-semibold">Mencoba mendapatkan lokasi akurat...</span>
                    <span class="text-xs mt-1 text-orange-600">Mohon izinkan pop-up browser.</span>
                </div>`;
                
                navigator.geolocation.getCurrentPosition(showPosition, showError, {
                    enableHighAccuracy: true, 
                    timeout: 7000, 
                    maximumAge: 0
                });

            } else {
                resultDiv.innerHTML = `<div class='text-red-600 font-semibold p-4 bg-red-100 rounded-xl shadow'>‚ùå Geolocation tidak didukung oleh browser ini.</div>`;
            }
        }

        // Fungsi untuk menampilkan dan menyimpan posisi
        async function showPosition(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const accuracy = position.coords.accuracy; 
            const timestamp = new Date().toISOString();
            
            // Tampilan saat proses pengiriman data
            resultDiv.innerHTML = `
                <div class="p-6 bg-blue-50 text-blue-700 rounded-xl shadow-inner text-left border-l-4 border-blue-500">
                    <p class="font-bold mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path></svg>
                        Lokasi Ditemukan!
                    </p>
                    <p class="text-sm"><strong>Koordinat:</strong> ${lat.toFixed(5)}, ${lon.toFixed(5)}</p>
                    <div class="mt-4 flex items-center">
                        <div class="spinner ease-linear rounded-full border-2 border-t-2 border-blue-200 h-6 w-6 mr-3"></div>
                        <span class="text-sm">Mengecek Alamat dan Menyimpan Data...</span>
                    </div>
                </div>
            `;

            // --- 1. Ambil Alamat IP ---
            const ipAddress = await getClientIpAddress();
            
            // --- 2. Ambil Info Perangkat, OS & Browser ---
            const userAgent = navigator.userAgent || 'N/A';
            const { os, deviceType } = getOSNameAndDeviceType(userAgent);
            const browserName = getBrowserName(userAgent); 
            
            // --- 3. Reverse Geocoding untuk mendapatkan alamat spesifik ---
            const addressInfo = await getAddressFromLatLng(lat, lon);
            const fullAddress = addressInfo.fullAddress;
            const cityOrDistrict = addressInfo.cityOrDistrict;
            
            // === PEMERIKSAAN ERROR API ===
            if (fullAddress.startsWith("API Error:") || fullAddress.includes("Geocoding Status: ZERO_RESULTS") || fullAddress.includes("API Key Invalid")) {
                resultDiv.innerHTML = `
                    <div class="bg-red-50 p-6 rounded-xl shadow-md border-l-4 border-red-500 text-left">
                        <p class='text-red-700 font-bold text-lg mb-2 flex items-center'>
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                            Gagal Reverse Geocoding
                        </p>
                        <p class="text-sm text-red-600 mb-2">Error: **${fullAddress}**</p>
                        <p class="text-xs text-red-800 mt-3 font-semibold">Tolong ganti variabel **GOOGLE_MAPS_API_KEY** dengan kunci yang valid.</p>
                    </div>
                `;
                console.error("Geocoding API failed, stopping Firestore save.");
                return; 
            }
            // =================================

            // Data yang akan disimpan di Firestore
            const dataLokasi = {
                userId: userId, // User ID yang terotentikasi/anonim
                appId: appId,   // App ID dari Canvas
                latitude: lat,
                longitude: lon,
                accuracy: accuracy, 
                ipAddress: ipAddress, 
                fullAddress: fullAddress, ¬† ¬† ¬†
                cityOrDistrict: cityOrDistrict, 
                os_name: os, ¬† ¬† ¬† ¬† ¬† ¬† 
                device_type: deviceType, 
                browser_name: browserName, 
                timestamp: serverTimestamp(), // Menggunakan fungsi serverTimestamp() dari V9
                browserTime: timestamp,
                userAgent: userAgent 
            };
            
            // KIRIM DATA ke koleksi 'locations' di jalur public
            const locationsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'locations');
            
            addDoc(locationsColRef, dataLokasi)
            .then((docRef) => {
                
                const mapUrl = `https://maps.google.com/maps?q=${lat},${lon}&z=15`;
                
                // Menentukan Tampilan Akurasi
                let accuracyBg, accuracyTextColor, accuracyStatus;
                if (accuracy < 50) {
                    accuracyBg = 'bg-green-100 border-green-400';
                    accuracyTextColor = 'text-green-700';
                    accuracyStatus = 'Sangat Tinggi (GPS Akurat)';
                } else if (accuracy < 500) {
                    accuracyBg = 'bg-yellow-100 border-yellow-400';
                    accuracyTextColor = 'text-yellow-700';
                    accuracyStatus = 'Cukup Baik (Radius Wi-Fi/Seluler)';
                } else {
                    accuracyBg = 'bg-red-100 border-red-400';
                    accuracyTextColor = 'text-red-700';
                    accuracyStatus = 'Rendah (Hanya Berdasarkan Jaringan)';
                }


                // Tampilan Berhasil Tersimpan (menggunakan Tailwind)
                resultDiv.innerHTML = `
                    <div class="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-indigo-500 text-left">
                        <p class='text-indigo-600 font-extrabold text-xl mb-4 flex items-center'>
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.204A9.959 9.959 0 0012 3a9.957 9.957 0 00-7.817 3.784A1 1 0 005.42 7.784L12 18.001l6.58-10.217a1 1 0 00-.002-1.879z"></path></svg>
                            Data Lokasi Disimpan!
                        </p>
                        
                        <div class="space-y-3 text-sm text-gray-700">
                            <div class="flex">
                                <span class="font-semibold text-gray-900 w-28">Alamat:</span> <span class="flex-1">${fullAddress}</span>
                            </div>
                            <div class="flex">
                                <span class="font-semibold text-gray-900 w-28">Koordinat:</span> <span class="flex-1">${lat.toFixed(6)}, ${lon.toFixed(6)}</span>
                            </div>
                            
                            <div class="p-3 ${accuracyBg} rounded-lg border">
                                <div class="flex justify-between items-center">
                                    <span class="font-bold ${accuracyTextColor}">Akurasi: ${accuracy.toFixed(2)} m</span>
                                    <span class="text-xs font-semibold ${accuracyTextColor} px-2 py-1 rounded-full border border-current">${accuracyStatus}</span>
                                </div>
                            </div>
                            
                            <div class="flex pt-2 border-t border-gray-100">
                                <span class="font-semibold text-gray-900 w-28">IP Address:</span> <span class="flex-1">${ipAddress}</span>
                            </div>
                            <div class="flex">
                                <span class="font-semibold text-gray-900 w-28">Perangkat:</span> <span class="flex-1">${browserName} (${deviceType})</span>
                            </div>
                            <div class="flex">
                                <span class="font-semibold text-gray-900 w-28">User ID:</span> <span class="flex-1 text-xs break-all">${userId}</span>
                            </div>
                            
                            <a href="${mapUrl}" target="_blank" class="block w-full text-center mt-5 text-white bg-indigo-500 hover:bg-indigo-600 font-bold py-3 px-4 rounded-xl transition duration-150 shadow-lg hover:shadow-xl">
                                üìç Lihat Lokasi di Google Maps
                            </a>
                            <p class="text-xs text-gray-400 pt-2 text-center">Doc ID: ${docRef.id} | App ID: ${appId}</p>
                        </div>
                    </div>
                `;
            })
            .catch((error) => {
                // Tampilan Gagal Tersimpan
                resultDiv.innerHTML = `
                    <div class="bg-red-50 p-6 rounded-2xl shadow-xl border-l-4 border-red-500 text-left">
                        <p class='text-red-700 font-extrabold text-xl mb-3'>‚ùå Gagal Menyimpan ke Firebase</p>
                        <p class="text-sm text-gray-700">Error: ${error.message}</p>
                        <p class="text-xs mt-3 font-semibold">Pastikan koneksi internet, **Aturan Firestore** mengizinkan write ke jalur **public**, dan Firebase diinisialisasi dengan benar.</p>
                    </div>
                `;
            });
        }

        function showError(error) {
            let errorMessage = "Terjadi Kesalahan.";
            let iconSvg = `<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = "Anda **menolak** izin lokasi. Klik ikon gembok di address bar untuk mengizinkan.";
                    iconSvg = `<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>`;
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = "Informasi lokasi tidak tersedia. Cek koneksi GPS/Wi-Fi Anda.";
                    break;
                case error.TIMEOUT:
                    errorMessage = "Permintaan lokasi **habis waktu**. Coba lagi, pastikan koneksi cepat.";
                    break;
                case error.UNKNOWN_ERROR:
                    errorMessage = "Terjadi kesalahan yang tidak diketahui.";
                    break;
            }
            // Tampilan Gagal Mendapatkan Lokasi
            resultDiv.innerHTML = `
                <div class='bg-red-100 p-6 text-red-800 font-semibold rounded-2xl shadow border-l-4 border-red-500 text-left'>
                    <p class="text-lg mb-2 flex items-center">${iconSvg} GAGAL MENDAPATKAN LOKASI</p>
                    <p class="text-sm">${errorMessage}</p>
                </div>
            `;
        }
    </script>
</body>
</html>
