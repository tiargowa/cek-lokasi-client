<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cek Lokasi Client dan Simpan Data (Firebase)</title>
    <style>
        /* Gaya CSS */
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
            background-color: #f4f4f9;
        }
        h1 {
            color: #333;
        }
        #result {
            margin: 30px auto;
            padding: 25px;
            border: 1px solid #ddd;
            display: inline-block;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-width: 400px;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .loading {
            color: #ff9800; /* Warna oranye untuk loading */
        }
    </style>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variabel global yang disediakan oleh lingkungan Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const resultDiv = document.getElementById('result');

        // Fungsi untuk otentikasi
        async function authenticate() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Otentikasi berhasil menggunakan Custom Token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Otentikasi anonim berhasil.");
                }
            } catch (error) {
                console.error("Gagal otentikasi Firebase:", error);
                resultDiv.innerHTML = `<p class='error'>Gagal Otentikasi Firebase: ${error.message}</p>`;
                return false;
            }
            return true;
        }

        // Fungsi utama untuk mendapatkan lokasi
        async function getLocation() {
            resultDiv.innerHTML = '<p class="loading">Memuat lokasi...</p>';

            const isAuthenticated = await authenticate();
            if (!isAuthenticated) return;
            
            // Mengambil data dari browser dan OS
            const userAgent = navigator.userAgent;
            const screenInfo = `${screen.width}x${screen.height}`;
            const clientTime = new Date().toLocaleString('id-ID');

            if (navigator.geolocation) {
                // Kode Geolocation API yang benar-benar merupakan JavaScript
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        showPosition(position, userAgent, screenInfo, clientTime);
                    },
                    showError,
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                resultDiv.innerHTML = '<p class="error">Geolocation tidak didukung oleh browser ini.</p>';
            }
        }

        function showPosition(position, userAgent, screenInfo, clientTime) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const accuracy = position.coords.accuracy;

            resultDiv.innerHTML = `
                <p class='success'>Lokasi Berhasil Diperoleh!</p>
                <strong>Lat/Lon:</strong> ${lat.toFixed(6)}, ${lon.toFixed(6)}<br>
                <strong>Akurasi:</strong> &plusmn;${accuracy.toFixed(2)} meter<br>
                <span style="font-size: small; color: #333;">Browser/OS: ${userAgent}</span><br>
                <span style="font-size: small; color: #333;">Waktu Client: ${clientTime}</span>
            `;

            saveLocation(lat, lon, accuracy, userAgent, screenInfo, clientTime);
        }

        async function saveLocation(lat, lon, accuracy, userAgent, screenInfo, clientTime) {
            // Path koleksi untuk data private user
            const userId = auth.currentUser?.uid || 'anonymous';
            const collectionPath = `artifacts/${appId}/users/${userId}/location_history`;
            
            const dataToSave = {
                latitude: lat,
                longitude: lon,
                accuracy: accuracy,
                timestamp: Date.now(),
                userAgent: userAgent,
                screenInfo: screenInfo,
                clientTime: clientTime,
                userId: userId // Simpan userId di dokumen
            };

            try {
                const docRef = await addDoc(collection(db, collectionPath), dataToSave);
                // Tampilan Berhasil Tersimpan
                resultDiv.innerHTML += `
                    <p class='success'>Data lokasi berhasil disimpan ke Firestore!</p>
                    <p style="font-size: small; color: green;">ID Dokumen: ${docRef.id}</p>
                `;
            } catch (error) {
                // Tampilan Gagal Tersimpan
                resultDiv.innerHTML += `
                    <p class='error'>Gagal menyimpan lokasi ke Firebase: ${error.message}</p>
                    <p>Pastikan koneksi internet, Aturan Firestore, dan Google Maps API Key sudah diatur dengan benar.</p>
                `;
                console.error("Error saving document: ", error);
            }
        }

        function showError(error) {
            let errorMessage = "Terjadi Kesalahan.";
            let userActionMessage = ""; // Tambahkan variabel untuk saran pengguna
            let errorCode = error.code;

            switch(errorCode) {
                case error.PERMISSION_DENIED:
                    // Perbaikan: Pesan yang lebih deskriptif dan berisi saran tindakan
                    errorMessage = "Akses lokasi ditolak oleh Anda atau pengaturan browser.";
                    userActionMessage = "<p style='font-size: small;'>Silakan izinkan akses lokasi di pengaturan browser Anda dan coba muat ulang halaman.</p>";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = "Informasi lokasi tidak tersedia (jaringan atau perangkat bermasalah).";
                    break;
                case error.TIMEOUT:
                    errorMessage = "Permintaan lokasi habis waktu (timeout).";
                    break;
                case error.UNKNOWN_ERROR:
                    errorMessage = "Terjadi kesalahan yang tidak diketahui.";
                    break;
            }
            
            // Menggabungkan pesan error utama dengan saran tindakan pengguna (jika ada)
            resultDiv.innerHTML = `<p class='error'>Gagal mendapatkan lokasi: ${errorMessage}</p>${userActionMessage}`;
            
            // Mencatat pesan kesalahan yang lebih deskriptif ke konsol
            console.error(`Geolocation Error (Code: ${errorCode || 'N/A'}): ${errorMessage}. Detail Objek:`, error);
        }
        
        // PANGGIL FUNGSI SAAT HALAMAN DIMUAT (Aksi Otomatis)
        getLocation(); 
    </script>

</head>
<body>
    <h1>Lacak Lokasi Client</h1>
    <p>Aplikasi ini secara otomatis mencoba mendapatkan dan menyimpan lokasi Anda ke Firebase Firestore.</p>
    
    <div id="result">
        <p class="loading">Memuat lokasi...</p>
    </div>

</body>
</html>
