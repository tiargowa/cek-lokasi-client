<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cek Lokasi Client dan Simpan Data (Aman & Akurat)</title>
    <!-- Memuat Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Mengatur font utama menjadi Inter (default Tailwind) */
        body { font-family: 'Inter', sans-serif; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script>
        // ====================================================================
        // Konfigurasi Kunci API (Disembunyikan)
        // Kunci API Firebase diambil secara otomatis dari variabel global yang aman.
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // KUNCI GOOGLE MAPS MASIH HARUS DISEDIAKAN SECARA MANUAL
        // HARAP GANTI DENGAN KUNCI ANDA YANG SUDAH DIAKTIFKAN GEOCODING API-nya!
        const GOOGLE_MAPS_API_KEY = "AIzaSyAuObjcNZrJjdfrRN1c-sSwr0qGktoRgDE"; 
        // ====================================================================


        // Inisialisasi Firebase dan Firestore
        let db;
        if (Object.keys(firebaseConfig).length > 0) {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
        } else {
            console.error("Konfigurasi Firebase tidak tersedia.");
        }
    </script>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4">

    <!-- Kontainer Utama (Menggunakan Tailwind untuk Styling) -->
    <div class="bg-white shadow-xl rounded-xl p-8 max-w-lg w-full transform transition duration-500 hover:shadow-2xl">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-6 border-b pb-3">Aplikasi Cek Lokasi Anda</h1>
        
        <div id="result" class="text-gray-600 text-center">
            Menunggu izin lokasi. Mohon izinkan pop-up browser.
        </div>
        
        <p class="text-xs text-gray-400 mt-4 text-center">API Key Google Maps tetap diperlukan untuk Reverse Geocoding.</p>
    </div>

    <script>
        const resultDiv = document.getElementById('result');

        // Fungsi untuk mendapatkan Alamat Jalan/Kota dari Lat/Lon (Reverse Geocoding)
        async function getAddressFromLatLng(lat, lng) {
            if (GOOGLE_MAPS_API_KEY === "AIzaSyAuObjcNZrJjdfrRN1c-sSwr0qGktoRgDE") { 
                console.warn("GOOGLE_MAPS_API_KEY masih menggunakan placeholder. Reverse Geocoding mungkin gagal.");
            }

            const url = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${GOOGLE_MAPS_API_KEY}`;
            
            try {
                const response = await fetch(url);

                if (!response.ok) {
                    let errorMessage = `API Error: ${response.status}`;
                    return { fullAddress: errorMessage, cityOrDistrict: 'Error' };
                }

                const data = await response.json();

                if (data.status === 'OK' && data.results.length > 0) {
                    const fullAddress = data.results[0].formatted_address;
                    let cityOrDistrict = fullAddress;
                    const components = data.results[0].address_components;
                    
                    for (const component of components) {
                        if (component.types.includes("locality")) {
                            cityOrDistrict = component.long_name;
                            break;
                        }
                        if (component.types.includes("administrative_area_level_2")) {
                            cityOrDistrict = component.long_name;
                        }
                    }

                    return { fullAddress, cityOrDistrict };
                } else {
                    return { fullAddress: `Geocoding Status: ${data.status} (Pesan: ${data.error_message || 'Tidak ada pesan'})`, cityOrDistrict: 'Tidak Diketahui' };
                }
            } catch (error) {
                console.error("Gagal melakukan Reverse Geocoding (Koneksi Gagal):", error);
                return { fullAddress: 'Error: Gagal Fetch Geocoding', cityOrDistrict: 'Error' };
            }
        }

        // Fungsi utilitas untuk mendapatkan Nama Browser
        function getBrowserName(userAgent) {
            let browser = 'Unknown Browser';
            if (userAgent.indexOf("Chrome") > -1 && userAgent.indexOf("Edge") === -1) {
                browser = 'Chrome';
            } else if (userAgent.indexOf("Firefox") > -1) {
                browser = 'Firefox';
            } else if (userAgent.indexOf("Safari") > -1 && userAgent.indexOf("Chrome") === -1) {
                browser = 'Safari';
            } else if (userAgent.indexOf("Edge") > -1) {
                browser = 'Edge';
            } else if (userAgent.indexOf("Trident") > -1) {
                browser = 'Internet Explorer';
            }
            return browser;
        }

        // Fungsi utilitas untuk mengurai UserAgent dan mendapatkan nama OS yang lebih baik dan Tipe Perangkat
        function getOSNameAndDeviceType(userAgent) {
            let os = 'Unknown OS';
            let deviceType = 'Desktop';
            
            // Cek OS
            if (userAgent.match(/Windows NT 10.0/i)) os = 'Windows 10/11';
            else if (userAgent.match(/Android/i)) os = 'Android';
            else if (userAgent.match(/iPhone|iPad|iPod/i)) os = 'iOS/iPadOS';
            else if (userAgent.match(/Macintosh|Mac OS X/i)) os = 'Mac OS';
            else if (userAgent.match(/Linux/i)) os = 'Linux';

            // Cek Tipe Perangkat
            if (userAgent.match(/Mobi/i)) {
                deviceType = 'Mobile Phone';
            } else if (userAgent.match(/Tablet|iPad/i)) {
                deviceType = 'Tablet';
            }
            
            return { os, deviceType };
        }

        // Fungsi baru untuk mendapatkan Alamat IP dari API eksternal
        async function getClientIpAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip || 'Tidak Ditemukan';
            } catch (error) {
                console.error("Gagal mendapatkan Alamat IP:", error);
                return 'Error: Cek Koneksi/API';
            }
        }

        // Fungsi utama untuk meminta Geolocation
        function getLocation() {
            if (navigator.geolocation) {
                // Tampilan Loading Awal (Menggunakan Tailwind dan Spinner SVG)
                resultDiv.innerHTML = `<div class="p-4 bg-yellow-100 text-yellow-800 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 mr-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 0014 4h-1.582m2.418 16H4v-5m15.356-2A8.001 8.001 0 0020 14h-1.582"></path></svg>
                    <span>Mencoba mendapatkan lokasi. Mohon izinkan pop-up browser.</span>
                </div>`;
                
                navigator.geolocation.getCurrentPosition(showPosition, showError, {
                    enableHighAccuracy: true, // Mencoba mendapatkan akurasi terbaik (GPS)
                    timeout: 5000,
                    maximumAge: 0
                });

            } else {
                resultDiv.innerHTML = `<p class='text-red-600 font-semibold p-4 bg-red-100 rounded-lg'>Geolocation tidak didukung oleh browser ini.</p>`;
            }
        }

        // Fungsi untuk menampilkan dan menyimpan posisi
        async function showPosition(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const accuracy = position.coords.accuracy; // <<< DATA AKURASI BARU (dalam meter)
            const timestamp = new Date().toISOString();
            
            // Tampilan saat proses pengiriman data
            resultDiv.innerHTML = `
                <div class="p-4 bg-blue-50 text-blue-700 rounded-lg shadow-inner text-left">
                    <p class="font-bold mb-2">Lokasi berhasil ditemukan!</p>
                    <p><strong>Latitude:</strong> ${lat.toFixed(5)}</p>
                    <p><strong>Longitude:</strong> ${lon.toFixed(5)}</p>
                    <p><strong>Akurasi (Radius):</strong> ${accuracy.toFixed(2)} meter</p>
                    <div class="mt-3 flex items-center">
                        <svg class="w-5 h-5 mr-2 animate-pulse text-blue-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-7-8a7 7 0 1114 0 7 7 0 01-14 0z" clip-rule="evenodd"></path></svg>
                        <span>Mengambil IP, Perangkat, dan Alamat Spesifik...</span>
                    </div>
                </div>
            `;

            // --- 1. Ambil Alamat IP ---
            const ipAddress = await getClientIpAddress();
            
            // --- 2. Ambil Info Perangkat, OS & Browser ---
            const userAgent = navigator.userAgent || 'N/A';
            const { os, deviceType } = getOSNameAndDeviceType(userAgent);
            const browserName = getBrowserName(userAgent); 
            
            // --- 3. Reverse Geocoding untuk mendapatkan alamat spesifik ---
            const addressInfo = await getAddressFromLatLng(lat, lon);
            const fullAddress = addressInfo.fullAddress;
            const cityOrDistrict = addressInfo.cityOrDistrict;
            
            // === PEMERIKSAAN ERROR API BARU ===
            if (fullAddress.startsWith("API Error:") || fullAddress.includes("Geocoding Status: ZERO_RESULTS") || fullAddress.includes("API Key Invalid")) {
                resultDiv.innerHTML = `
                    <div class="bg-red-50 p-4 rounded-lg shadow-md border-l-4 border-red-500 text-left">
                        <p class='text-red-700 font-bold mb-2'>‚ùå GAGAL MENGAMBIL ALAMAT SPESIFIK</p>
                        <p class="text-sm text-red-600 mb-2">Reverse Geocoding GAGAL. Pesan Error:</p>
                        <p class="text-xs text-red-900 bg-red-100 p-2 rounded break-words">${fullAddress}</p>
                        <p class="text-sm mt-3 font-semibold">Tolong periksa kembali **Kunci Google Maps API** Anda (termasuk Geocoding API).</p>
                    </div>
                `;
                console.error("Geocoding API failed, stopping Firestore save.");
                return; // Hentikan eksekusi jika Geocoding gagal
            }
            // =================================

            // Data yang akan disimpan di Firestore
            const dataLokasi = {
                latitude: lat,
                longitude: lon,
                accuracy: accuracy, // <<< SIMPAN DATA AKURASI
                ipAddress: ipAddress, 
                fullAddress: fullAddress,      
                cityOrDistrict: cityOrDistrict, 
                os_name: os,             
                device_type: deviceType, 
                browser_name: browserName, 
                timestamp: firebase.firestore.FieldValue.serverTimestamp(), 
                browserTime: timestamp,
                userAgent: userAgent 
            };

            // KIRIM DATA ke koleksi (tabel) 'locations' di Firestore
            db.collection("locations").add(dataLokasi)
            .then((docRef) => {
                
                const mapUrl = `https://maps.google.com/maps?q=${lat},${lon}&z=12`;

                // Tampilan Berhasil Tersimpan (menggunakan Tailwind)
                resultDiv.innerHTML = `
                    <div class="bg-green-100 p-6 rounded-lg shadow-xl border-l-4 border-green-500 text-left">
                        <p class='text-green-700 font-extrabold text-xl mb-4'>‚úÖ Lokasi Tersimpan!</p>
                        
                        <div class="space-y-3 text-sm text-gray-700">
                            <div><span class="font-semibold text-gray-900">Alamat Spesifik:</span> ${fullAddress}</div>
                            <div><span class="font-semibold text-gray-900">Koordinat:</span> ${lat.toFixed(5)}, ${lon.toFixed(5)}</div>
                            
                            <div class="py-1 px-3 ${accuracy > 1000 ? 'bg-red-100 border-red-300' : accuracy > 100 ? 'bg-yellow-100 border-yellow-300' : 'bg-green-100 border-green-300'} rounded-md border">
                                <span class="font-semibold text-gray-900">Akurasi:</span> ${accuracy.toFixed(2)} meter
                                <p class="text-xs ${accuracy > 1000 ? 'text-red-700' : 'text-gray-500'} mt-1">
                                    ${accuracy > 1000 ? '‚ö†Ô∏è Akurasi Rendah (Kemungkinan dari IP).' : 'Akurasi Tinggi (GPS/Wi-Fi terdekat).'}
                                </p>
                            </div>
                            
                            <div><span class="font-semibold text-gray-900">IP Address:</span> ${ipAddress}</div>
                            <div><span class="font-semibold text-gray-900">Perangkat:</span> ${browserName} di ${os} (${deviceType})</div>
                            
                            <a href="${mapUrl}" target="_blank" class="inline-block mt-4 text-white bg-blue-500 hover:bg-blue-600 font-bold py-2 px-4 rounded-full transition duration-150 shadow-md">
                                üó∫Ô∏è Lihat di Google Maps
                            </a>
                            <p class="text-xs text-green-800 pt-2">ID Dokumen: ${docRef.id}</p>
                        </div>
                    </div>
                `;
            })
            .catch((error) => {
                // Tampilan Gagal Tersimpan
                resultDiv.innerHTML = `
                    <div class="bg-red-50 p-6 rounded-lg shadow-xl border-l-4 border-red-500 text-left">
                        <p class='text-red-700 font-extrabold text-xl mb-3'>‚ùå Gagal Menyimpan ke Firebase</p>
                        <p class="text-sm text-gray-700">Error: ${error.message}</p>
                        <p class="text-xs mt-2 font-semibold">Pastikan koneksi internet dan **Aturan Firestore** sudah diatur ke **'if true'**.</p>
                    </div>
                `;
            });
        }

        function showError(error) {
            let errorMessage = "Terjadi Kesalahan.";
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = "Anda menolak permintaan Geolocation. Izin diperlukan.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = "Informasi lokasi tidak tersedia. Coba cek koneksi GPS/Wi-Fi.";
                    break;
                case error.TIMEOUT:
                    errorMessage = "Permintaan untuk mendapatkan lokasi habis waktu (timeout).";
                    break;
                case error.UNKNOWN_ERROR:
                    errorMessage = "Terjadi kesalahan yang tidak diketahui.";
                    break;
            }
            // Tampilan Gagal Mendapatkan Lokasi
            resultDiv.innerHTML = `<div class='bg-red-100 p-4 text-red-800 font-semibold rounded-lg shadow'>‚ö†Ô∏è Gagal mendapatkan lokasi: ${errorMessage}</div>`;
        }
        
        // PANGGIL FUNGSI SAAT HALAMAN DIMUAT (Aksi Otomatis)
        if (db) {
             getLocation(); 
        } else {
             resultDiv.innerHTML = `<p class='text-red-600 font-semibold p-4 bg-red-100 rounded-lg'>‚ùå Gagal Inisialisasi Firebase. Cek konfigurasi.</p>`;
        }
    </script>

</body>
</html>
